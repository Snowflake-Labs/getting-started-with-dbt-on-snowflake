name: Periodic CI Schema Cleanup

on:
  # æ¯é€±æœˆæ›œæ—¥ã®åˆå‰3æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 3 * * 1'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (just list schemas without deleting)'
        required: false
        default: 'false'
      retention_days:
        description: 'Delete schemas older than X days'
        required: false
        default: '7'

jobs:
  cleanup-old-schemas:
    runs-on: ubuntu-latest
    
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install snowflake-connector-python requests
      
      - name: Cleanup old CI schemas
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          RETENTION_DAYS: ${{ github.event.inputs.retention_days || '7' }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import re
          import requests
          from datetime import datetime, timedelta
          import snowflake.connector
          
          # è¨­å®š
          dry_run = os.environ.get('DRY_RUN', 'false').lower() == 'true'
          retention_days = int(os.environ.get('RETENTION_DAYS', '7'))
          cutoff_date = datetime.now() - timedelta(days=retention_days)
          
          print(f"ğŸ” Cleanup mode: {'DRY RUN' if dry_run else 'ACTIVE'}")
          print(f"ğŸ“… Retention period: {retention_days} days")
          print(f"ğŸ“… Cutoff date: {cutoff_date.strftime('%Y-%m-%d')}")
          print()
          
          # GitHub APIã§ã‚ªãƒ¼ãƒ—ãƒ³ä¸­ã®PRã‚’å–å¾—
          github_token = os.environ['GITHUB_TOKEN']
          repo = os.environ['GITHUB_REPOSITORY']
          headers = {
              'Authorization': f'token {github_token}',
              'Accept': 'application/vnd.github.v3+json'
          }
          
          print("ğŸ“‹ Fetching open pull requests...")
          response = requests.get(
              f'https://api.github.com/repos/{repo}/pulls?state=open',
              headers=headers
          )
          open_prs = {pr['number'] for pr in response.json()}
          print(f"âœ… Found {len(open_prs)} open PRs")
          print()
          
          # Snowflakeæ¥ç¶š
          print("ğŸ”Œ Connecting to Snowflake...")
          conn = snowflake.connector.connect(
              account=os.environ['SNOWFLAKE_ACCOUNT'],
              user=os.environ['SNOWFLAKE_USER'],
              password=os.environ['SNOWFLAKE_PASSWORD'],
              role=os.environ['SNOWFLAKE_ROLE'],
              warehouse=os.environ['SNOWFLAKE_WAREHOUSE'],
              database=os.environ['SNOWFLAKE_DATABASE']
          )
          
          try:
              cursor = conn.cursor()
              
              # CI_PR_ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚¹ã‚­ãƒ¼ãƒã‚’æ¤œç´¢
              print("ğŸ” Searching for CI schemas...")
              cursor.execute("SHOW SCHEMAS LIKE 'CI_PR_%'")
              schemas = cursor.fetchall()
              
              print(f"ğŸ“Š Found {len(schemas)} CI schemas")
              print()
              
              schemas_to_delete = []
              schemas_to_keep = []
              
              for schema_info in schemas:
                  schema_name = schema_info[1]  # ã‚¹ã‚­ãƒ¼ãƒå
                  created_on = schema_info[0]   # ä½œæˆæ—¥æ™‚
                  
                  # PRç•ªå·ã‚’æŠ½å‡º
                  match = re.search(r'CI_PR_(\d+)', schema_name, re.IGNORECASE)
                  if not match:
                      continue
                  
                  pr_number = int(match.group(1))
                  
                  # å‰Šé™¤å¯¾è±¡ã®åˆ¤å®š
                  should_delete = False
                  reason = ""
                  
                  if pr_number not in open_prs:
                      should_delete = True
                      reason = "PR is closed or merged"
                  elif created_on < cutoff_date:
                      should_delete = True
                      reason = f"Schema is older than {retention_days} days"
                  
                  if should_delete:
                      schemas_to_delete.append({
                          'name': schema_name,
                          'pr': pr_number,
                          'created': created_on,
                          'reason': reason
                      })
                  else:
                      schemas_to_keep.append({
                          'name': schema_name,
                          'pr': pr_number,
                          'created': created_on
                      })
              
              # ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
              print("=" * 60)
              print(f"ğŸ“Š CLEANUP SUMMARY")
              print("=" * 60)
              print(f"Schemas to keep: {len(schemas_to_keep)}")
              print(f"Schemas to delete: {len(schemas_to_delete)}")
              print()
              
              if schemas_to_keep:
                  print("âœ… Schemas to KEEP:")
                  for schema in schemas_to_keep:
                      print(f"  - {schema['name']} (PR #{schema['pr']}, created: {schema['created']})")
                  print()
              
              if schemas_to_delete:
                  print("ğŸ—‘ï¸  Schemas to DELETE:")
                  for schema in schemas_to_delete:
                      print(f"  - {schema['name']} (PR #{schema['pr']}, {schema['reason']})")
                  print()
                  
                  if not dry_run:
                      print("ğŸ”¥ Deleting schemas...")
                      for schema in schemas_to_delete:
                          try:
                              cursor.execute(f"DROP SCHEMA IF EXISTS {schema['name']} CASCADE")
                              print(f"  âœ… Deleted: {schema['name']}")
                          except Exception as e:
                              print(f"  âŒ Failed to delete {schema['name']}: {str(e)}")
                      print()
                      print(f"âœ… Cleanup completed! Deleted {len(schemas_to_delete)} schemas")
                  else:
                      print("â„¹ï¸  DRY RUN mode - no schemas were actually deleted")
              else:
                  print("âœ¨ No schemas to delete")
              
              print("=" * 60)
          
          except Exception as e:
              print(f"âŒ Error: {str(e)}")
              raise
          
          finally:
              cursor.close()
              conn.close()
          PYTHON_SCRIPT
      
      - name: Create summary
        if: always()
        run: |
          echo "## ğŸ§¹ CI Schema Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ github.event.inputs.dry_run == 'true' && 'ğŸ” DRY RUN' || 'ğŸ”¥ ACTIVE' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Retention:** ${{ github.event.inputs.retention_days || '7' }} days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for detailed results." >> $GITHUB_STEP_SUMMARY
